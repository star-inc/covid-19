const init_location=[23.73,120.89],origin_container=$("#countries").clone(),data_url="https://pomber.github.io/covid19/timeseries.json",data2_url="https://gist.githubusercontent.com/supersonictw/86038eb5cda33229d6367e4f7499e066/raw/8442d13be6e531eb82407fdb5d1124255655a3d2/countries.json";class analysis{constructor(){this.map=L.map("map"),this.total={confirmed:0,recovered:0,deaths:0},this.data={},this.data2={}}setmap(t,a){this.map.setView(t,a),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'<a href="https://www.openstreetmap.org/">OSM</a>',maxZoom:18}).addTo(this.map)}total_reset(){this.total={confirmed:0,recovered:0,deaths:0}}total_add(t){this.total.confirmed+=t.confirmed,this.total.recovered+=t.recovered,this.total.deaths+=t.deaths}data_info(t){return[t.confirmed-t.recovered-t.deaths,t.recovered,t.deaths]}chart(t,a){let e=document.getElementById("chart").getContext("2d");new Chart(e,{type:"line",data:{labels:t,datasets:[{label:"# 例",data:a,borderColor:"rgba(65, 133, 255, 0.5)"}]}})}chart2(t){let a=this.data_info(t),e=document.getElementById("chart2").getContext("2d");new Chart(e,{type:"pie",data:{labels:["治療中","康復","死亡"],datasets:[{label:"例",data:a,borderColor:["rgba(220, 0, 130, 0.5)","rgba(15, 205, 25, 0.5)","rgba(0, 0, 0, 0.5)"],backgroundColor:["rgba(220, 0, 130, 0.5)","rgba(15, 205, 25, 0.5)","rgba(0, 0, 0, 0.5)"]}]}})}chart3(t){let a=this.data_info(t),e=document.getElementById("chart3").getContext("2d");new Chart(e,{type:"polarArea",data:{labels:["治療中","康復","死亡"],datasets:[{label:"例",data:a,borderColor:["rgba(220, 0, 15, 0.7)","rgba(0, 0, 255, 0.7)","rgba(0, 0, 0, 0.7)"],backgroundColor:["rgba(220, 0, 15, 0.7)","rgba(0, 0, 255, 0.7)","rgba(0, 0, 0, 0.7)"]}]}})}locale(t){if(this.map.eachLayer(t=>this.map.removeLayer(t)),"global"===t)this.setmap(init_location,3),$("#countries").html(origin_container);else{let a=function(t,a){return"<h4>"+t+"</h4><p>"+a+'</p><div class="data-container"><div id="data-date"></div><canvas id="chart" width="100%" height="60px"></canvas><canvas id="chart2" width="100%" height="60px"></canvas></div><p><a href="javascript:context.locale(\'global\');">返回</a></p>'},e=this,o=function(t){let o=e.data2[t].location;e.setmap(o,5),L.marker(o).addTo(e.map),$("#countries").html(a(e.data2[t].zh_TW,t))},d=function(t,a){let o=[],d=e.data[a].length;for(let r=t;r<d;r++)o.push(e.data[a][r].confirmed);$("#data-date").text("From "+e.data[a][t].date+" to "+e.data[a][d-1].date),e.chart(Object.keys(o),o),e.chart2(e.data[a][d-1])};setTimeout(function(){o(t),d(50,t)},100)}}time(){let t=function(t,a){a.forEach(function(a){t[a]<10&&(t[a]="0"+t[a])})},a=new Date,e={y:a.getFullYear(),M:a.getMonth()+1,d:a.getDate(),h:a.getHours(),m:a.getMinutes(),s:a.getSeconds()};return t(e,["M","d","h","m","s"]),e.y+"-"+e.M+"-"+e.d+" "+e.h+":"+e.m+":"+e.s}display(){this.total_reset(),$("#countries-data").html("");let t=function(t,a,e){return'<tr><th scope="row" onclick="context.locale(\''+t+"')\">"+a+"</th><td>"+e.confirmed+"</td><td>"+e.recovered+"</td><td>"+e.deaths+"</td></tr>"};for(let a in this.data){let e=this.data[a].length-1;this.data2.hasOwnProperty(a)&&this.data2[a].hasOwnProperty("zh_TW")?$("#countries-data").append(t(a,this.data2[a].zh_TW,this.data[a][e])):$("#countries-data").append(t(a,a,this.data[a][e])),this.total_add(this.data[a][e])}$("#worldwide-data").html("<tr><td>"+this.total.confirmed+"</td><td>"+this.total.recovered+"</td><td>"+this.total.deaths+"</td></tr>"),this.chart3(this.total),$("#lastupdate").text(this.time())}async update(){let t=async function(t){return new Promise(function(a){$.getJSON(t,a)})};this.data=await t(data_url),this.data2=await t(data2_url),this.display()}}let context=new analysis;$(function(){context.locale("global"),action=context.update(),setInterval(action,18e5)});